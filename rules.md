# macdiet 開発ルール（AIエージェント運用・進行方法）

この文書は「macdiet」を **仕様通りに、安全に、継続的に** 開発するための運用ルールを定義する。実装要件の一次情報は `仕様書.md`。

## 1. 目的（このプロジェクトが提供する価値）

- macOSの「System Data」として一括計上されがちな領域を、**原因カテゴリへ再分類**し、根拠（Evidence）付きで提示する。
- 改善策は **安全度（Risk: R0〜R3）で段階化**し、既定は診断のみ（R0）。ユーザーの明示操作がある場合のみ、ホワイトリストされた安全な範囲で限定的に実行する。
- 人間向け表示と機械向けJSON出力を両立する。

## 2. 仕様遵守のルール（最重要）

- 新しい機能・挙動を追加/変更する前に、必ず `仕様書.md` の該当FR/安全モデル/UX要件を確認する。
- 仕様に曖昧さがある場合は「安全側（Read-only）」に倒し、`now-task.md` に要確認事項として残す。
- Non-Goals（SIP無効化、rootless回避、OS領域改変、System Dataの“ゼロ化”）に抵触する実装は行わない。

## 3. タスク管理（now-task.md）

`now-task.md` は **単一の信頼できる進捗表** とする（他のTODO断片を増やさない）。

- 形式はチェックリストを基本に、次の3区分を維持する:
  - 進行中（In Progress）
  - 進行予定（Planned）
  - 完了済み（Done）
- 着手時:
  - 進行中に **ちょうど1件** を置く（同時並行を避ける）。
  - タスクは `Txx:` のIDを付け、DoD（完了条件）を1行で書く。
- 完了時:
  - 完了済みに移動し、成果物（追加/変更ファイル、コマンド、判断）を短く添える。

## 4. レビュー運用（review.md）

`review.md` は「仕様適合・安全・UX・品質」を定期点検した **記録** とする。

- 実施タイミング（いずれか）:
  - 目安: 3タスク完了ごと
  - 大きい設計変更の直後
  - リリース準備（v0.1など）の前
- レビュー観点（最低限）:
  - `仕様書.md` のMVP条件（v0.1）への到達度
  - 安全モデル（R0既定、ホワイトリスト、2段階確認、非TTY対話禁止）
  - UX要件（進捗、テーブル整形、エラーブロック、stdout/stderr分離）
  - テスト（ユニット/統合/セーフティ）と不確実性（未観測領域）
  - ドキュメント（README/docs/SECURITY.md）の不足点

## 5. 安全モデル実装ルール（R0〜R3）

`仕様書.md` の安全モデルを、実装判断の最優先基準にする。

- 既定は **R0（Read-only）**。`--apply` が無い限りファイル変更や外部破壊コマンド実行はしない。
- `fix` は `--dry-run` を既定とし、`--apply` でのみ実行する。
- 危険操作の制御:
  - `--risk`（許容最大リスク）を必須のゲートとして実装する。
  - R2以上は二段階確認（TTY限定）。非TTY時は失敗させる。
  - sudo昇格はツール側で勝手に行わない（ユーザーが明示的に `sudo macdiet ...` する前提）。
- パス制限:
  - 実行対象は「ルールが生成した候補」かつ「ホワイトリスト一致」かつ「期待する所有者/種別」を満たすものだけに限定する。
  - 原則 `TRASH_MOVE`、`DELETE` は例外（追加同意・明確な根拠が必要）。

## 6. UXルール（Claude Code級）

- 進捗表示: 深いスキャンや外部コマンド待ちでは必ず進捗を出す（非TTYでは簡素化）。
- 表示:
  - 重要度で色分け（`--no-color`/非TTYで無効）
  - テーブルは列幅自動調整、`ui.max_table_rows` を尊重
- エラーは「何が/なぜ/次に何を」を1ブロックで提示する。
- stdout/stderr分離:
  - stdout: 結果（`--json` 時はJSONのみ）
  - stderr: 進捗、診断ログ、警告

## 7. アーキテクチャ（実装方針）

`仕様書.md` の推奨分割を基本に、変更する場合は理由を `review.md` に残す。

- 推奨モジュール:
  - `cli/`：引数解析、入出力整形
  - `core/`：Finding/Action/Reportのドメインモデル
  - `scan/`：ファイル走査、集計、除外
  - `rules/`：検出ルール（Xcode/Docker等）
  - `actions/`：dry-run/apply、Trash移動、外部コマンド
  - `platform/macos/`：tmutil/diskutil呼び出し、権限チェック
- 依存は最小限にし、外部コマンドはタイムアウト/エラーの扱いを統一する。

## 8. テストと品質ゲート

- 優先度:
  1) セーフティ（`--apply` なしで変更ゼロ、ホワイトリスト外拒否）
  2) JSONスキーマ互換（golden）
  3) ルール判定と集計（ユニット/統合）
- 非TTYモードの挙動（対話禁止、色禁止）は統合テストで担保する。

