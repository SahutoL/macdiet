# 仕様書：macdiet（仮称） — macOSストレージ肥大化診断・最適化CLI

## 0. 目的と思想

### 0.1 目的（Goals）

1. macOSのストレージ使用量、とくに「System Data（システムデータ）」として一括計上されがちな領域を、原因カテゴリに再分類して提示する。

2. Appleが言う通り、System Dataは「他カテゴリに属さないApple/サードパーティのファイルをまとめた一般カテゴリ」であり、中身は雑多で変動する。
3. 開発者環境で頻出の肥大化要因（Xcode派生物、Simulator、Docker、ログ/キャッシュ等）を、根拠（Evidence）付きでランキング表示する。
4. 改善策を「安全度（Risk）」で段階化し、既定はRead-only（診断のみ）、ユーザー明示操作がある場合のみ、ホワイトリスト化された安全な範囲で削減を実行する。
5. 人間向け整形表示と、機械向けJSON出力を両立する（CI/自動化・他ツール連携可能）。

⠀
### 0.2 非目的（Non-Goals）

* 「System Dataをゼロにする」「OS領域を強制削除する」類の危険な最適化はしない。
* SIP無効化、rootless回避、カーネル/システムファイル改変はしない。
* macOS標準UIの表示（ストレージカテゴリ表示）の“正確な再現”は目的ではない（Apple側の分類はブラックボックス寄りで変動するため）。
---

## 1. 対象環境

### 1.1 対象OS

* macOS Tahoe 26.x（最新系のみ）。

* ※将来の26.xマイナー差異にはパッチで追随する前提。

### 1.2 対象ユーザー

* 開発者（Xcode / Simulator / Docker / Homebrew 等を日常利用）
* ストレージ逼迫時に、根拠を見て合理的に掃除したい層

### 1.3 実行形態

* CLI（単一バイナリを基本）
* Homebrew配布・cargo install 対応
---

## 2. 用語定義

* Finding：肥大化要因の“検出結果”。サイズ推定・根拠・推奨アクションを含む。
* Evidence：推定に用いたパス、コマンド出力、集計値などの再現可能な根拠。
* Action：改善策。dry-run で差分見積もり、applyで実行。
* Risk Level：実行の安全度。後述のR0〜R3。
* System Data：macOSストレージ表示上のカテゴリ名。一般カテゴリであり「Apple/サードパーティのうち他カテゴリに属さないもの」。
* Local snapshots：Time Machineがバックアップディスク不在でも復元できるようMac内に保持するローカルスナップショット。
* APFS snapshots：APFSボリュームの読み取り専用スナップショット（Disk Utilityでも閲覧/削除可能）。
---

## 3. 安全モデル（最重要）

### 3.1 リスクレベル

* R0（Read-only）：診断のみ。ファイル操作なし。デフォルト。
* R1（Safe cleanup）：ユーザー領域の明確に安全な掃除（派生ビルド物、キャッシュ等）。Trash移動が原則。
* R2（Potentially disruptive）：再生成は可能だが時間/設定影響があり得る（Dockerイメージ削除、Simulator整理など）。明示確認が必須。
* R3（System-adjacent / privileged）：スナップショットの薄め（thin）/削除等。誤操作の影響が大きく、sudoや強い同意が必要。Appleはローカルスナップショットは容量が必要なとき等に自動削除されるとしており、基本は“診断＋必要時の手動実行”を推奨する。

### 3.2 破壊操作の原則

* dry-runが既定（削除量見積もりのみ）
* ホワイトリスト対象のみ（パスパターン・所有者・種別で限定）
* 直接削除（unlink）は原則禁止：Trash移動を基本（例外は巨大キャッシュでTrashが非現実的な場合のみ、追加同意が必要）
* TTY判定：非TTY（パイプ/リダイレクト）時は対話禁止。危険操作は失敗させる。
* ログ分離：機械可読出力はstdout、診断ログはstderr。
* Full Disk Accessが無い場合：見えない領域を“ゼロ扱い”せず「未観測」として表示。
---

## 4. コア機能要求（Functional Requirements）

### 4.1 診断（Doctor）

FR-DOCTOR-1：doctor は短時間（目標：~30秒以内）でトップ要因を提示する

* 対象：開発者頻出パス、スナップショットの有無、主要キャッシュ
* 出力：

  * 合計（推定）
  * 上位N件（既定N=10）のFinding
  * 推奨アクション（安全度順）
  * 未観測領域（権限不足）警告

FR-DOCTOR-2：doctor は “System Dataになりやすい原因” を優先的に推定・説明する

* 例：ローカルスナップショット、ログ/キャッシュ、開発者データ
* System Dataの説明はAppleの定義に従い「一般カテゴリ」であることを明記する。

### 4.2 詳細スキャン（Scan）

FR-SCAN-1：scan --deep で、ユーザー指定のスコープをファイル木走査して集計

* 走査の既定スコープ：~/Library を中心に、開発者由来の既知パスを優先
* 除外：.git、node_modules等（設定で変更可）

FR-SCAN-2：巨大ディレクトリのランキング（深さ制限付き）

* --top-dirs=K、--max-depth=D などで制御

### 4.3 スナップショット診断（Snapshots）

FR-SNAP-1：Time Machineローカルスナップショットの存在検出

* 取得：tmutil listlocalsnapshots /（存在有無、個数）
* Appleの説明（ローカルスナップショットの目的）を要約表示。

FR-SNAP-2：APFSスナップショットの存在検出（可能範囲）

* Disk Utilityで閲覧・削除できることを提示。
* CLIでの削除はR3扱い（既定OFF）。diskutil apfs deleteSnapshot 系はユーザーの明示選択時のみ（コマンド仕様は環境で差異があり得るため、ツール内でhelp/usage参照またはUUID指定で実行）。

FR-SNAP-3：薄め（thin）実行（R3）

* tmutil thinlocalsnapshots <mount> <bytes> <urgency> 形式をサポート（urgencyは1〜4）。
* ただしAppleは「容量が必要なとき/24時間超などで自動削除」としているため、ツールは “まず診断と必要性説明” を優先する。

### 4.4 開発者起因の肥大化（Developer Artifacts）

FR-DEV-1：Xcode DerivedData のサイズ推定・上位プロジェクト推定

* パス：~/Library/Developer/Xcode/DerivedData（一般的）
* 推奨：XcodeのUI経由削除導線＋CLIでの安全削除（R1）

FR-DEV-2：Simulator（CoreSimulator）のデータ肥大化検出

* 近年は ~/Library/Developer/CoreSimulator/Devices を中心に肥大化し得る、という開発者向け実態に基づきカテゴリ化（R2）。

FR-DEV-3：Archives / DeviceSupport 等の“再生成可能だが影響がある”領域を別カテゴリ扱い（R2）

* 実行は必ず対話式または --yes-i-know 系の強制フラグが必要

### 4.5 コンテナ・VM起因（Docker等）

FR-DOCKER-1：Docker Desktop系の肥大化検出（R2）

* 可能なら docker system df 等のコマンドが存在するときは併用（無ければファイルベース推定）
* 削除は docker system prune 相当の危険性を明示し、ツール内から実行する場合は詳細確認必須

### 4.6 レポート（Report）

FR-REPORT-1：report --json は全Findingを機械可読で出す

* スキーマ固定（後述）
* 互換性：semverに基づくバージョニング（破壊変更はメジャーアップ）
---

## 5. CLI仕様（Command Spec）

### 5.1 コマンド一覧（トップレベル）

* macdiet doctor
* macdiet scan
* macdiet snapshots
* macdiet fix
* macdiet report
* macdiet completion
* macdiet config

### 5.2 共通オプション

* --json：人間向け表示を抑制しJSONをstdoutへ
* --no-color：色無効
* --verbose：詳細ログ（stderr）
* --quiet：最小出力（結果のみ）
* --config <path>：設定ファイルパス
* --timeout <sec>：外部コマンド実行上限
* --dry-run：アクション差分だけ計算（fix系の既定）

### 5.3

### doctor

目的：短時間で「上位原因→推奨アクション」

出力（人間向け）：

* Summary：合計/未観測/推定誤差の注記
* Top Findings（表）
* Recommended Actions（Risk順：R1→R2→R3）
* 注意：System Dataは一般カテゴリであることを明記。

終了コード：

* 0：成功（Findingが0でも0）
* 2：引数不正
* 10：スキャン中断（権限不足以外の致命）
* 20：外部コマンド失敗（診断継続可能なら0で警告に落とす設定も可）

### 5.4

### scan

* scan --scope <preset|path>

  * preset例：dev / userlib / all-readable
* scan --deep（ファイル木走査を増やす）
* scan --max-depth D
* scan --top-dirs K
* scan --exclude <glob>（複数可）

### 5.5

### snapshots

* snapshots status：

  * Time Machineローカルスナップショット（存在/個数）
  * APFSスナップショット（可能な範囲）
  * Appleの説明（ローカルスナップショットの役割、削除が自動で走る条件）を提示。
* snapshots thin --bytes <N> --urgency <1..4>（R3、sudo推奨）

  * tmutil thinlocalsnapshots を使用。
* snapshots delete --id <snapshot>（R3、既定無効）

  * Disk Utilityで削除できることを先に推奨し、CLI削除は明確な同意が必要。
  * diskutil apfs deleteSnapshot ... 等を利用する場合、UUID/Name指定のsyntaxが環境で差異があり得るため、ツール側で検出したID形式のみ受理。

### 5.6

### fix

* fix --interactive：対話式にAction候補を提示（TTY限定）
* fix --apply：実行（デフォルトはdry-run）
* fix --risk <=R1|R2|R3>：許容する最大リスク
* fix --target <finding_id...>：対象限定

必須挙動：

* 実行前に「削減見込み（bytes）」と「影響（再生成、再ログイン、再ビルド等）」を表示
* --apply 時は二段階確認（R2以上は追加確認）

### 5.7

### report

* report --json：完全JSON（stdout）
* report --markdown：貼り付けやすい要約
* report --include-evidence：根拠のパス/コマンド出力を含める（個人情報配慮のマスク設定あり）

### 5.8

### completion

* completion bash|zsh|fish：シェル補完スクリプト生成
---

## 6. 検出カテゴリ（Finding Types）とルール

各Findingは以下を必ず持つ：

* id（安定ID）
* type
* title
* estimated_bytes
* confidence（0.0〜1.0）
* evidence[]
* risk_level
* recommended_actions[]

### 6.1 Snapshot系

* TM_LOCAL_SNAPSHOTS_PRESENT

  * 根拠：tmutil listlocalsnapshots / の結果
  * 注記：自動削除条件（容量必要時/古い場合）を明示。
  * アクション：R3 thin（任意）
* APFS_SNAPSHOTS_PRESENT

  * 根拠：Disk Utilityで閲覧・削除可能であること、または diskutil apfs listSnapshots 等
  * アクション：基本はGUI誘導、CLI削除はR3。

### 6.2 Xcode系（開発者特化の核）

* XCODE_DERIVED_DATA_LARGE（R1）
* CORESIMULATOR_DEVICES_LARGE（R2、消すとシミュレータ状態が飛ぶ可能性）
* XCODE_ARCHIVES_LARGE（R2）
* DEVICE_SUPPORT_LARGE（R2）

### 6.3 キャッシュ/ログ（保守的に）

* USER_CACHE_LARGE（R1〜R2：アプリ別/領域別に分ける）
* LOGS_LARGE（R1：ただし現在動作中プロセスのログは注意）

### 6.4 パッケージ/ツールチェーン

* HOMEBREW_CACHE_LARGE（R1）
* RUST_CARGO_CACHE_LARGE（R1：~/.cargo/registry, ~/.cargo/git 等）
* NODE/YARN/PNPM_CACHE_LARGE（R1）

### 6.5 Docker/VM

* DOCKER_STORAGE_LARGE（R2）
---

## 7. 推定（Estimation）仕様

### 7.1 サイズ推定の原則

* 可能ならディレクトリ内のファイルサイズ総和を計測
* 未読領域は「0」ではなく unobserved として別計上
* スナップショット領域は“見かけ上の増減が直ちに反映されない”場合があるため、「推定が難しい」ことを明記し、ユーザーが行うべき確認（再起動、Disk Utility、df等）を案内

### 7.2 Confidence計算（例）

* 直接走査できた：0.9
* コマンド出力依存：0.8
* 権限不足で一部未観測：0.5
* 推定（ヒューリスティック）：0.3
---

## 8. アクション（Action）仕様

### 8.1 Actionの種類

* TRASH_MOVE(path[])：Trashへ移動（既定）
* DELETE(path[])：恒久削除（例外的、追加同意必須）
* RUN_CMD(cmd, args)：外部コマンド（例：tmutil）
* OPEN_IN_FINDER(path)：GUI誘導（安全策）
* SHOW_INSTRUCTIONS(markdown)：手順提示

### 8.2 トランザクション

* apply 実行時は、Actionごとにログを残す（ローカル）

  * 実行日時
  * 対象パス
  * 実行結果
  * ロールバック可能性（Trash移動なら復帰可能）

### 8.3 権限

* R1/R2：ユーザー権限で可能な範囲のみ
* R3：sudo が必要な場合を想定（ただしツールが勝手に昇格せず、ユーザーが明示的にsudoで起動する前提）
---

## 9. 設定（Config）仕様

### 9.1 設定ファイル形式

* TOML
* デフォルトパス：~/.config/macdiet/config.toml

### 9.2 優先順位

CLI引数 > 環境変数 > config.toml > 組み込みデフォルト

### 9.3 主なキー（例）

* ui.color = true|false
* ui.max_table_rows = 20
* scan.default_scope = "dev"
* scan.exclude = ["**/node_modules/**", ...]
* fix.default_risk_max = "R1"
* privacy.mask_home = true
* report.include_evidence = false
---

## 10. JSONレポート仕様（固定スキーマ）

### 10.1 ルート

```
{
  "schema_version": "1.0",
  "tool_version": "0.1.0",
  "os": { "name": "macOS", "version": "26.x" },
  "generated_at": "RFC3339",
  "summary": {
    "estimated_total_bytes": 0,
    "unobserved_bytes": 0,
    "notes": []
  },
  "findings": [ /* Finding[] */ ],
  "actions": [ /* ActionPlan[] (dry-run時) */ ]
}
```

### 10.2 Finding

* id: string
* type: string
* title: string
* estimated_bytes: number
* confidence: number
* risk_level: "R0"|"R1"|"R2"|"R3"
* evidence: Evidence[]
* recommended_actions: ActionRef[]

### 10.3 Evidence

* kind: "path"|"command"|"stat"
* value: string
* masked: boolean
---

## 11. UX要件（Claude Code級の“気持ちよさ”を作る）

### 11.1 表示

* 重要度で色分け（ただし--no-color/非TTYで無効）
* テーブル表示は列幅自動調整
* 進捗（indicatif系）を必ず出す（深いスキャン時）

### 11.2 エラー表示

* 「何が起きたか」＋「なぜ起きたか」＋「次に何をすべきか」を1ブロックで出す
* Full Disk Access不足は、未観測として扱い、設定手順のヒントを添える（断定しない）
---

## 12. 内部アーキテクチャ（実装要件）

### 12.1 モジュール分割（推奨）

* cli/：clap定義、入出力整形
* core/：Finding/Action/Reportのドメインモデル
* scan/：ファイル走査、集計、除外
* rules/：Findingルール（Xcode/Docker等）
* actions/：dry-run/apply、Trash移動、外部コマンド実行
* platform/macos/：tmutil/diskutil呼び出し、権限チェック

### 12.2 外部コマンド

* tmutil：ローカルスナップショットの検出・thin（形式は一般に thinlocalsnapshots <mount> <bytes> <urgency> として説明される）
* APFSスナップショット：Disk Utilityで閲覧/削除が可能であることを一次情報として扱う。

* CLI削除に踏み込む場合、diskutil apfs deleteSnapshot 等のsyntax例は存在するが環境差があり得るため、ツール内で検出したIDのみ許可し、危険操作として扱う。
---

## 13. テスト要件

### 13.1 ユニットテスト

* ルール判定（パス→Finding）
* JSONスキーマ互換（golden test）

### 13.2 統合テスト

* tmpdir上に擬似的な ~/Library/Developer/... を構成し、scan→findings→report を検証
* 非TTYモードの挙動（対話禁止、色禁止）

### 13.3 セーフティテスト

* ホワイトリスト外パスをActionに入れようとすると拒否
* --apply なしではファイル変更が一切起きないこと
---

## 14. リリース・配布

* cargo install macdiet
* Homebrew Tap（brew install <tap>/macdiet）
* 署名は任意（ただしmacOSで警告回避したい場合は将来検討）
* バージョニング：semver
---

## 15. ドキュメント要件（OSSとしての必須物）

* README：目的/安全モデル/代表ユースケース/FAQ
* docs/：

  * “System Dataとは何か（一般カテゴリ）”をApple定義ベースで説明
  * “ローカルスナップショットは自動削除されるが例外もある”をAppleの説明ベースで説明
  * Disk UtilityでAPFSスナップショットを扱える導線
* SECURITY.md：危険操作方針（R3の扱い）
---

# MVP（v0.1）完了条件

1. doctor が上位10原因＋推奨アクションを出す
2. scan --deep が指定スコープを集計できる
3. Xcode（DerivedData + CoreSimulator）をFinding化できる（サイズ推定＋パス根拠）
4. snapshots status がローカルスナップショットの存在を示し、Appleの挙動説明を表示できる
5. report --json が固定スキーマで出る
6. fix は R1のみを dry-run まで提供（applyは次版でも可）
